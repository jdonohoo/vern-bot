#!/bin/bash
#
# vernhole: Summon random Vern personas for chaotic discovery
#
# Usage: vernhole "<idea>" [output_dir] [num_verns] [context_file]
#   idea: The idea to explore
#   output_dir: Where to save output (default: current dir)
#   num_verns: Number of Verns to summon, min 5 (default: random 5-max)
#   context_file: Optional path to a context file (e.g. a discovery master plan)
#                 whose contents will be included in each persona's prompt
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERN_RUN="$SCRIPT_DIR/vern-run"
AGENTS_DIR="$SCRIPT_DIR/../agents"

IDEA="$1"
OUTPUT_DIR="${2:-.}"
CONTEXT_FILE="${4:-}"

if [ -z "$IDEA" ]; then
    echo "Usage: vernhole \"<idea>\" [output_dir] [num_verns] [context_file]"
    exit 1
fi

# ── Dynamically build roster from agents/*.md ────────────────────────────────
# Parses YAML frontmatter for name, description, model. Skips vernhole-orchestrator.
# Maps model (opus/sonnet/haiku) to LLM engine for vern-run.

VERNS=()

if command -v python3 &>/dev/null && [ -d "$AGENTS_DIR" ]; then
    while IFS='|' read -r vern_id llm desc; do
        VERNS+=("${vern_id}:${llm}:${desc}")
    done < <(python3 -c "
import os, re, sys

agents_dir = '$AGENTS_DIR'
model_to_llm = {'opus': 'claude', 'sonnet': 'claude', 'haiku': 'claude'}

for fname in sorted(os.listdir(agents_dir)):
    if not fname.endswith('.md') or fname == 'vernhole-orchestrator.md':
        continue
    path = os.path.join(agents_dir, fname)
    with open(path) as f:
        content = f.read()
    # Parse YAML frontmatter between --- markers
    m = re.match(r'^---\s*\n(.*?)\n---', content, re.DOTALL)
    if not m:
        continue
    front = m.group(1)
    name = ''
    desc = ''
    model = 'claude'
    for line in front.split('\n'):
        if line.startswith('name:'):
            name = line.split(':', 1)[1].strip()
        elif line.startswith('description:'):
            desc = line.split(':', 1)[1].strip()
            # Take just the short descriptor before the first period or dash explanation
            desc = desc.split(' - ', 1)[-1].split('. ')[0] if ' - ' in desc else desc.split('. ')[0]
        elif line.startswith('model:'):
            model = line.split(':', 1)[1].strip()
    llm = model_to_llm.get(model, 'claude')
    if name:
        print('{}|{}|{}'.format(name, llm, desc))
" 2>/dev/null)
fi

# Fallback: if dynamic scan failed or no agents found, use hardcoded roster
if [ ${#VERNS[@]} -eq 0 ]; then
    VERNS=(
        "mediocre:claude:Vern the Mediocre - scrappy speed demon, ship it fast"
        "great:claude:Vernile the Great - excellence incarnate, elegant solutions"
        "nyquil:claude:Nyquil Vern - brilliant but brief, NyQuil kicking in"
        "ketamine:claude:Ketamine Vern - multi-dimensional vibes, sees patterns"
        "yolo:claude:YOLO Vern - full send, no guardrails"
        "mighty:claude:MightyVern - raw power, comprehensive analysis"
        "inverse:claude:Inverse Vern - contrarian takes only"
        "paranoid:claude:Paranoid Vern - what could possibly go wrong?"
        "optimist:claude:Optimist Vern - everything will be fine!"
        "academic:claude:Academic Vern - needs more research, cites sources"
        "startup:claude:Startup Vern - MVP or die, move fast"
        "enterprise:claude:Enterprise Vern - needs 6 meetings and a committee"
        "architect:claude:Architect Vern - systems design, blueprints before builds"
    )
fi

ROSTER_SIZE=${#VERNS[@]}
MIN_VERNS=5
NUM_VERNS="${3:-$(shuf -i ${MIN_VERNS}-${ROSTER_SIZE} -n 1)}"

# Clamp to roster size
if [ "$NUM_VERNS" -gt "$ROSTER_SIZE" ]; then
    NUM_VERNS="$ROSTER_SIZE"
fi
if [ "$NUM_VERNS" -lt "$MIN_VERNS" ]; then
    NUM_VERNS="$MIN_VERNS"
fi

# Build context block if a context file was provided
CONTEXT_BLOCK=""
if [ -n "$CONTEXT_FILE" ] && [ -f "$CONTEXT_FILE" ]; then
    CONTEXT_BLOCK="

=== PRIOR DISCOVERY PLAN ===
The following plan was synthesised from a full Vern Discovery Pipeline run on this idea. Use it as context, but bring your own unique perspective. Challenge it, build on it, tear it apart — whatever your persona demands.

$(cat "$CONTEXT_FILE")

=== END PRIOR DISCOVERY PLAN ==="
    echo "Context loaded from: $CONTEXT_FILE"
    echo ""
fi

# Create project name from idea
PROJECT_NAME=$(echo "$IDEA" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | cut -c1-40)
VERNHOLE_DIR="$OUTPUT_DIR/vernhole/$PROJECT_NAME"

echo "=== WELCOME TO THE VERNHOLE ==="
echo "Idea: $IDEA"
echo "Roster: $ROSTER_SIZE Verns available"
echo "Summoning $NUM_VERNS Verns..."
echo ""

mkdir -p "$VERNHOLE_DIR"

# Randomly select Verns
SELECTED=$(printf '%s\n' "${VERNS[@]}" | shuf -n "$NUM_VERNS")

# Track all outputs for synthesis
ALL_OUTPUTS=""
VERN_NUM=1

while IFS= read -r vern_line; do
    IFS=':' read -r vern_id model desc <<< "$vern_line"

    echo ">>> Vern $VERN_NUM/$NUM_VERNS: $desc"

    LLM="$model"

    OUTPUT_FILE="$VERNHOLE_DIR/$(printf '%02d' $VERN_NUM)-$vern_id.md"

    "$VERN_RUN" "$LLM" "You are $desc. Analyze this idea from your unique perspective. Be true to your persona.

Original idea: $IDEA$CONTEXT_BLOCK" "$OUTPUT_FILE"

    ALL_OUTPUTS="$ALL_OUTPUTS

=== $desc ===
$(cat "$OUTPUT_FILE")"

    ((VERN_NUM++))
    echo ""
done <<< "$SELECTED"

echo ">>> Synthesizing the chaos..."
"$VERN_RUN" claude "You are the VernHole Orchestrator. Synthesize these diverse perspectives into actionable insights. Identify common themes, interesting contradictions, and recommended paths forward.

ORIGINAL IDEA: $IDEA
$CONTEXT_BLOCK
THE VERNS HAVE SPOKEN:
$ALL_OUTPUTS" "$VERNHOLE_DIR/synthesis.md"

echo ""
echo "=== THE VERNHOLE HAS SPOKEN ==="
echo "Files created in: $VERNHOLE_DIR"
ls -la "$VERNHOLE_DIR"
