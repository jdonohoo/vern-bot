#!/bin/bash
#
# vern-oracle: Post-hoc Oracle operations (consult and apply)
#
# Delegates to the Go vern CLI binary. Auto-downloads if not present.
#
# Usage:
#   vern-oracle consult --synthesis-dir <dir> [--vts-dir <dir>] [flags] "<idea>"
#   vern-oracle apply --vision-file <file> --vts-dir <dir> [flags]
#
# Flags:
#   --synthesis-dir <dir>   Directory containing synthesis.md (consult)
#   --vts-dir <dir>         Directory containing vts-*.md files
#   --vision-file <file>    Path to oracle-vision.md (apply)
#   --output <file>         Custom output file path
#   --llm-mode <mode>       LLM fallback mode
#   --single-llm <llm>      Use a single LLM for all steps
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERN_CLI="$SCRIPT_DIR/../go/bin/vern"

# Auto-download if Go binary doesn't exist
if [ ! -x "$VERN_CLI" ]; then
    if command -v go &>/dev/null && [ -f "$SCRIPT_DIR/../go/cmd/vern/main.go" ]; then
        echo "[vern-oracle] Building vern CLI from source..." >&2
        (cd "$SCRIPT_DIR/../go" && go build -o bin/vern ./cmd/vern) 2>/dev/null
    fi
    if [ ! -x "$VERN_CLI" ] && [ -x "$SCRIPT_DIR/install-vern-cli" ]; then
        "$SCRIPT_DIR/install-vern-cli"
    fi
    if [ ! -x "$VERN_CLI" ]; then
        echo "[vern-oracle] Error: vern CLI not available. Run: cd go && go build -o bin/vern ./cmd/vern" >&2
        exit 1
    fi
fi

exec "$VERN_CLI" oracle "$@"
