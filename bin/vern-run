#!/bin/bash
#
# vern-run: Spawn different LLM subprocesses for Vern-Bot
#
# Usage: vern-run <llm> "<prompt>" [output_file]
#   llm: claude | codex | gemini
#   prompt: The prompt to send
#   output_file: Optional file to save output
#

set -e

LLM="$1"
PROMPT="$2"
OUTPUT_FILE="$3"

if [ -z "$LLM" ] || [ -z "$PROMPT" ]; then
    echo "Usage: vern-run <llm> \"<prompt>\" [output_file]"
    echo "  llm: claude | codex | gemini"
    exit 1
fi

# Prompt wrapper for claude/gemini: output text only, no file creation
TEXT_ONLY="IMPORTANT: Output your complete analysis as plain text to stdout. Do NOT create, write, or modify any files. Do NOT use any file-writing tools. Just output your analysis directly as text.

"

# Sign-off: every Vern ends with a dad joke
DAD_JOKE="

---
SIGN-OFF: You MUST end your response with a dad joke that fits your persona. This is mandatory — it's the law. Format it as a horizontal rule followed by your joke."

run_claude() {
    NODE_OPTIONS="--max-old-space-size=32768" claude --dangerously-skip-permissions -p "${TEXT_ONLY}${PROMPT}${DAD_JOKE}"
}

run_codex() {
    # Codex is a code agent — without explicit instructions it will BUILD
    # things instead of PLANNING. We tell it to write analysis only, capture
    # via -o (last message), and sandbox in a temp dir for safety.
    local tmpdir=$(mktemp -d)
    local tmpout="$tmpdir/output.md"
    local codex_prefix="IMPORTANT: You are acting as a PLANNING and ANALYSIS agent for a discovery pipeline. Write your complete analysis, implementation plan, and recommendations as a detailed markdown document. Do NOT create any code files, project scaffolding, or application code. Do NOT build anything. Your entire output should be a thorough written analysis — problem space, architecture, risks, recommendations — not a built project.

"
    codex exec --dangerously-bypass-approvals-and-sandbox \
        --skip-git-repo-check \
        --cd "$tmpdir" \
        -o "$tmpout" \
        "${codex_prefix}${PROMPT}${DAD_JOKE}" >/dev/null 2>&1
    if [ -f "$tmpout" ]; then
        cat "$tmpout"
    fi
    rm -rf "$tmpdir"
}

run_gemini() {
    gemini --yolo "${TEXT_ONLY}${PROMPT}${DAD_JOKE}"
}

# Fallback: if requested LLM isn't installed, fall back to claude
ORIGINAL_LLM="$LLM"
case "$LLM" in
    codex|x)
        if ! command -v codex &>/dev/null; then
            echo "[vern-run] Warning: codex CLI not found, falling back to claude" >&2
            LLM="claude"
        fi
        ;;
    gemini|g)
        if ! command -v gemini &>/dev/null; then
            echo "[vern-run] Warning: gemini CLI not found, falling back to claude" >&2
            LLM="claude"
        fi
        ;;
esac

# Execute the appropriate LLM
case "$LLM" in
    claude|c)
        if [ -n "$OUTPUT_FILE" ]; then
            run_claude | tee "$OUTPUT_FILE"
        else
            run_claude
        fi
        ;;
    codex|x)
        if [ -n "$OUTPUT_FILE" ]; then
            run_codex | tee "$OUTPUT_FILE"
        else
            run_codex
        fi
        ;;
    gemini|g)
        if [ -n "$OUTPUT_FILE" ]; then
            run_gemini | tee "$OUTPUT_FILE"
        else
            run_gemini
        fi
        ;;
    *)
        echo "Unknown LLM: $LLM"
        echo "Valid options: claude, codex, gemini"
        exit 1
        ;;
esac
