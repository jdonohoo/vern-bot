#!/bin/bash
#
# vern-run: Spawn different LLM subprocesses for Vern-Bot
#
# Delegates to the Go vern CLI binary. Auto-downloads if not present.
#
# Usage: vern-run <llm> "<prompt>" [output_file] [persona]
#   llm: claude | codex | gemini
#   prompt: The prompt to send
#   output_file: Optional file to save output
#   persona: Optional persona name (loads agents/{persona}.md for personality context)
#
# Environment variables:
#   VERN_TIMEOUT       Per-step timeout in seconds (default: 1200 = 20 min)
#   VERN_WORKING_DIR   Working directory for codex (default: .)
#
# Exit codes:
#   0    Success
#   1    Usage error / unknown LLM
#   124  Timeout (GNU timeout convention)
#   *    LLM CLI failure
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERN_CLI="$SCRIPT_DIR/../go/bin/vern"

# Auto-download if Go binary doesn't exist
if [ ! -x "$VERN_CLI" ]; then
    # Try building from source first if Go is available
    if command -v go &>/dev/null && [ -f "$SCRIPT_DIR/../go/cmd/vern/main.go" ]; then
        echo "[vern-run] Building vern CLI from source..." >&2
        (cd "$SCRIPT_DIR/../go" && go build -o bin/vern ./cmd/vern) 2>/dev/null
    fi
    # If still not available, try downloading
    if [ ! -x "$VERN_CLI" ] && [ -x "$SCRIPT_DIR/install-vern-cli" ]; then
        "$SCRIPT_DIR/install-vern-cli"
    fi
    if [ ! -x "$VERN_CLI" ]; then
        echo "[vern-run] Error: vern CLI not available. Run: cd go && go build -o bin/vern ./cmd/vern" >&2
        exit 1
    fi
fi

# Map positional args to Go CLI flags
LLM="$1"
PROMPT="$2"
OUTPUT_FILE="$3"
PERSONA="$4"

if [ -z "$LLM" ] || [ -z "$PROMPT" ]; then
    echo "Usage: vern-run <llm> \"<prompt>\" [output_file] [persona]"
    echo "  llm: claude | codex | gemini"
    exit 1
fi

ARGS=("run" "$LLM" "$PROMPT")
[ -n "$OUTPUT_FILE" ] && ARGS+=("--output" "$OUTPUT_FILE")
[ -n "$PERSONA" ] && ARGS+=("--persona" "$PERSONA")

exec "$VERN_CLI" "${ARGS[@]}"
