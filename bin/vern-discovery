#!/bin/bash
#
# vern-discovery: Run the full Vern Discovery Pipeline
#
# Delegates to the Go vern CLI binary. Auto-downloads if not present.
#
# Usage:
#   Interactive:
#     vern-discovery "<idea>" [discovery_dir]
#
#   Batch (non-interactive, for skill/plugin use):
#     vern-discovery --batch "<idea>" [discovery_dir]
#     vern-discovery --batch --skip-input --vernhole 8 "<idea>" [discovery_dir]
#     vern-discovery --batch --vernhole-council hammers --oracle --oracle-apply "<idea>"
#
# Flags:
#   --batch          Non-interactive mode. Auto-reads input files, skips prompts.
#   --skip-input     In batch mode, don't read input/ files as context.
#   --vernhole N     After pipeline, run VernHole with N verns (0 to skip, default: skip).
#   --vernhole-council NAME  Use a named VernHole council tier.
#   --oracle         After VernHole, run Oracle Vern on synthesis + VTS tasks.
#   --oracle-apply   Auto-apply Oracle's vision via Architect Vern (implies --oracle).
#   --expanded       Use 7-step expanded pipeline (overrides config pipeline_mode).
#   --extra-context FILE  Add an extra context file (can be used multiple times).
#   --resume-from N  Resume pipeline from step N (skip earlier steps if output exists).
#   --max-retries N  Max retry attempts per step (default: 1).
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERN_CLI="$SCRIPT_DIR/../go/bin/vern"

# Auto-download if Go binary doesn't exist
if [ ! -x "$VERN_CLI" ]; then
    if command -v go &>/dev/null && [ -f "$SCRIPT_DIR/../go/cmd/vern/main.go" ]; then
        echo "[vern-discovery] Building vern CLI from source..." >&2
        (cd "$SCRIPT_DIR/../go" && go build -o bin/vern ./cmd/vern) 2>/dev/null
    fi
    if [ ! -x "$VERN_CLI" ] && [ -x "$SCRIPT_DIR/install-vern-cli" ]; then
        "$SCRIPT_DIR/install-vern-cli"
    fi
    if [ ! -x "$VERN_CLI" ]; then
        echo "[vern-discovery] Error: vern CLI not available. Run: cd go && go build -o bin/vern ./cmd/vern" >&2
        exit 1
    fi
fi

exec "$VERN_CLI" discovery "$@"
